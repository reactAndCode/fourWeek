# 메모 데이터베이스 스키마 업데이트

## 탭 기반 메모 시스템

메모를 탭별로 관리하기 위한 테이블 구조 업데이트

### my_memo 테이블 수정

기존 테이블에 `tab_name` 컬럼을 추가하고 제약조건을 수정합니다.

```sql
-- ============================================
-- my_memo 테이블 수정 (탭 기반)
-- ============================================

-- 기존 테이블 삭제 (개발 중이므로)
DROP TABLE IF EXISTS my_memo CASCADE;

-- 새로운 my_memo 테이블 생성
CREATE TABLE my_memo (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  tab_name TEXT NOT NULL DEFAULT 'Tab 1',
  title TEXT NOT NULL DEFAULT '제목 없음',
  content TEXT NOT NULL DEFAULT '',
  tags TEXT[] DEFAULT ARRAY[]::TEXT[],
  is_pinned BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL,

  -- 한 사용자는 각 탭에 하나의 메모만 작성
  CONSTRAINT unique_user_tab UNIQUE (user_id, tab_name)
);

-- 인덱스
CREATE INDEX idx_my_memo_user_tab
  ON my_memo(user_id, tab_name);

CREATE INDEX idx_my_memo_user_created
  ON my_memo(user_id, created_at DESC);

-- 코멘트
COMMENT ON TABLE my_memo IS '탭 기반 메모 테이블';
COMMENT ON COLUMN my_memo.tab_name IS '탭 이름 (Tab 1, Tab 2, ...)';
COMMENT ON COLUMN my_memo.title IS '메모 제목';
COMMENT ON COLUMN my_memo.content IS '메모 내용 (Markdown)';
COMMENT ON COLUMN my_memo.tags IS '메모 태그 배열';
COMMENT ON COLUMN my_memo.is_pinned IS '상단 고정 여부';

-- ============================================
-- RLS 정책
-- ============================================

ALTER TABLE my_memo ENABLE ROW LEVEL SECURITY;

CREATE POLICY "사용자는 자신의 메모를 조회할 수 있습니다"
  ON my_memo FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "사용자는 자신의 메모를 생성할 수 있습니다"
  ON my_memo FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "사용자는 자신의 메모를 수정할 수 있습니다"
  ON my_memo FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "사용자는 자신의 메모를 삭제할 수 있습니다"
  ON my_memo FOR DELETE
  USING (auth.uid() = user_id);

-- ============================================
-- updated_at 자동 갱신 트리거
-- ============================================

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = timezone('utc'::text, now());
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_my_memo_updated_at
  BEFORE UPDATE ON my_memo
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

## 기본 탭 데이터 생성 (선택사항)

```sql
-- 사용자가 처음 메모 페이지 접속 시 기본 탭들 자동 생성
-- 애플리케이션 레벨에서 처리하거나, 아래 함수 사용

CREATE OR REPLACE FUNCTION initialize_user_memo_tabs(p_user_id UUID)
RETURNS void AS $$
DECLARE
  tab_names TEXT[] := ARRAY['Tab 1', 'Tab 2', 'Tab 3', 'Tab 4', 'Tab 5',
                             'Tab 6', 'Tab 7', 'Tab 8', 'Tab 9', 'Tab 10'];
  tab_name TEXT;
BEGIN
  FOREACH tab_name IN ARRAY tab_names
  LOOP
    INSERT INTO my_memo (user_id, tab_name, title, content)
    VALUES (p_user_id, tab_name, '제목 없음', '')
    ON CONFLICT (user_id, tab_name) DO NOTHING;
  END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 사용 예시:
-- SELECT initialize_user_memo_tabs('your-user-id');
```

## 샘플 데이터

```sql
-- 테스트용 샘플 데이터 (user_id는 실제 사용자 ID로 변경)
INSERT INTO my_memo (user_id, tab_name, title, content, tags)
VALUES
  ('YOUR_USER_ID', 'Tab 1', '프로젝트 메모', '# 프로젝트 메모\n\n진행중인 작업들...', ARRAY['프로젝트']),
  ('YOUR_USER_ID', 'Tab 2', '회의록', '## 주간 회의\n\n- 논의사항...', ARRAY['회의']),
  ('YOUR_USER_ID', 'Tab 3', 'TODO', '- [ ] 작업 1\n- [ ] 작업 2', ARRAY['할일'])
ON CONFLICT (user_id, tab_name) DO UPDATE
SET title = EXCLUDED.title, content = EXCLUDED.content, tags = EXCLUDED.tags;
```

## 조회 쿼리

```sql
-- 특정 사용자의 모든 탭 메모 조회
SELECT tab_name, title, content, tags, updated_at
FROM my_memo
WHERE user_id = 'YOUR_USER_ID'
ORDER BY tab_name;

-- 특정 탭의 메모 조회
SELECT *
FROM my_memo
WHERE user_id = 'YOUR_USER_ID'
  AND tab_name = 'Tab 1';
```
